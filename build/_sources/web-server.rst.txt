Web-сервер
==========

Система оповещения
------------------

Триггеры событий
~~~~~~~~~~~~~~~~

По механизму настройки и функционированию триггеры можно разбить на три типа:

.. figure:: _static/1trigger_ru_en.png
       :scale: 100 %
       :align: center

* Триггеры, где каждое событие генерирует срабатывание. Настраивается только уровень.

.. figure:: _static/2trigger_ru.png
       :scale: 100 %
       :align: center

* Триггеры, интегрирующие длительность события на определенном интервале времени. Настраивается суммарная длительность события, интервал времени и уровень.


.. figure:: _static/3trigger_ru.png
       :scale: 100 %
       :align: center

* Триггеры, интегрирующие количество событий на определенном интервале времени. 

Настраивается суммарное количество событий, интервал времени и уровень.

По логике оповещения триггеры разделены на два типа: анонсирующие состояния и анонсирующие события.

**Состояния (state)** -  оповещения такого типа передают начало и конец события. Состояние передается в поле Status, которое может иметь значение active|cleared. Сообщения отправляются дважды, при появлении события и при его окончании. Например, при регистрации события BadSource (No signal), когда пропадают данные на входе анализатора, отправляется оповещение, в котором поле Status = active. Когда появляются валидные данные (ошибка снята), отправляется второе сообщение, в котором поле Status = cleared, и дополнительно фиксируется время окончания события.

**События (event)** - оповещения такого типа приходят единожды. В основном, такие оповещения связаны с фактом изменения состояния. Например, при каком-либо изменении в PSI таблице отправляется оповещение Program Specific Information changed. Для некоторых событий (Continuity Counter и Clock Continuity) оповещение отправляется при достижении установленного количества зарегистрированных ошибок.

Ниже перечислены все доступные триггеры и их краткое описание. Подробное  описание параметров и событий можно найти в параграфе `Регистрируемые параметры <probe.html#id25>`_. Подробное описание порогов и настроек можно найти в разделе `Q: Как настроить профили порогов (thresholds)?`_.

ETH
+++

.. csv-table:: 
   :header: "Имя триггера", "Тип", "Уровень", "Описание"
   
	"TOS/DSCP changed", "event", "Error", "Изменение TOS/DSCP поля."
	"TTL changed", "event", "Error", "Изменение TTL потока."
	"IAT Error", "state", "Error", "Превышение порога IAT Error."
	"IAT Warning", "state", "Warning", "Превышение порога IAT Warning."
	"MLR Error", "state", "Error", "Превышение порога MLR Error."
	"MLR Warning", "state", "Warning", "Превышение порога MLR Warning."
	"Max bitrate (Bitrate overflow)", "state", "Error", "Битрейт мультикаст потока выше заданного порога."
	"Min bitrate (Bitrate underflow)", "state", "Error", "Битрейт мультикаст потока ниже заданного порога."
	"BadSource (No signal)", "state", "Major", "Отсутствие сервиса (данных)."
	"Several broadcasters", "state", "Error", "Несколько источников мультикаста в одной группе."
	
ETR (TR 101 290)
++++++++++++++++

.. csv-table:: **Priority 1**
   :header: "Имя триггера", "Тип", "Уровень", "Описание"
   
   "TS Sync Loss", "state", "Major", "Потеря синхронизации транспортного потока."
   "Sync Byte Error", "state", "Major", "Отсутствие синхробайта 0x47 в следующем пакете."
   "PAT Error", "state", "Major", "Ошибки в приеме PAT таблицы."
   "Continuity Counter", "event", "Major", "Потеря транспортных пакетов."
   "PMT Error", "state", "Major", "Ошибки в приеме PMT таблицы."
   "PID error", "state", "Major", "Данные для указанного PID не появляются в течение установленного пользователем времени."
   "PID error (VidAud)", "state", "Major", "Данные для указанного аудио/видео PID не появляются в течение установленного пользователем времени."

.. csv-table:: **Priority 2**
   :header: "Имя триггера", "Тип", "Уровень", "Описание"  
   
   "Transport error", "state", "Major", "Поле Transport_error_indicator = 1."
   "Clock Continuity", "event", "Major", "Скачок или обратный прирост временных меток PTS/DTS."

STR
+++

.. csv-table:: 
   :header: "Имя триггера", "Тип", "Уровень", "Описание"  
   
   "Invalid Elementary Stream", "state", "Major", "В течение 20 секунд для видеопотока нет ни одного видео заголовка (SPS, PPS), возможно поток шифрованный."
   "Program Specific Information changed", "event", "Warning", "Изменилась информация о потоке, описанная в таблицах PAT, PMT и SDT."
   "Encryption map changed", "event", "Major", "Изменилась информация о шифровании PID."
   "Video Information changed", "event", "Warning", "Изменился заголовок(и) видеопотока(ов)."
   "Video Freeze Warning", "state", "Warning" 	
   "Video Freeze Error", "state", "Major", "Замирание картинки."

OTT
+++

.. csv-table:: 
   :header: "Имя триггера", "Тип", "Уровень", "Описание"  
   
   "Profile changed", "event", "OK", "Переключение на профиль с другим битрейтом. Только для анализатора в режиме «Плеер»."
   "The number of profiles changed", "event", "Warning", "Изменение количества профилей, заявленных в плейлисте верхнего уровня."
   "Minimum profiles", "state", "Warning", "Количество профилей, заявленных в плейлисте верхнего уровня, меньше, чем минимальное значение, заданное в настройках порогов."
   "Profiles sequence divergence", "event", "Warning", "Расхождение значения полей #EXT-X-MEDIA-SEQUENCE."
   "Profile streamtype changed", "event", "Warning", "Изменилась информация о профиле в плейлисте верхнего уровня."
   "Profile duplicate bandwidth", "state", "Error", "В плейлисте верхнего уровня заявлены одинаковые максимальные битрейты для разных профилей."
   "Profile invalid resolution", "state", "Error", "Некорректное разрешение в поле RESOLUTION плейлиста верхнего уровня."
   "Download bitrate low", "event", "Warning", "Низкая скорость скачивания чанка. Время загрузки / длительность чанка >= порог предупреждения (%)."
   "Download bitrate too low", "event", "Error", "Слишком низкая скорость скачивания чанка. Время загрузки / длительность чанка >= порог ошибки (%)."
   "Actual bitrate", "event", "Warning", "Средний битрейт скачанного сегмента больше или меньше порогов, заданных пользователем. Пороги задаются относительно битрейта, заявленного в плейлисте верхнего уровня (%)."
   "Bad segment size", "event", "Error", "Битрейт сегмента в 50 раз превышает максимальный битрейт, указанный в поле BANDWIDTH в плейлисте верхнего уровня."
   "Manifest sequence discontinuity", "event", "Error", "Потеря одного или нескольких плейлистов с потерей HLS сегментов. Данная ошибка может быть вызвана как проблемами в генерации и раздаче OTT контента, так и недостаточной производительностью зонда."
   "Static manifest", "state", "Major", "Плейлист второго уровня не обновился в течении нескольких скачиваний подряд. Число попыток задается пользователем в Number of identical playlist (sequance_age)."
   "Manifest error", "event", "Major", "Ошибка обработки/разбора плейлиста или несоответствие содержимого плейлиста стандарту."
   "Unknown manifest", "event", "Fatal", "Не удается распознать плейлист."
   "Manifest Size", "state", "Warning", "Размер плейлиста превышает пороговое значение Manifest size, установленное пользователем."
   "Manifest download failure", "event", "Fatal", "Невозможно скачать плейлист."
   "Key download failure", "event", "Error", "Невозможно скачать ключ для расшифровки сегмента."
   "Segment download failure", "event", "Error", "Невозможно скачать сегмент данных."
   "Skip segment (low system performance)", "event", "Major", "Пропущен сегмент данных. Недостаточная производительность зонда."
   "Start with an IDR frame", "state", 	"Error", "Проверка на то, что сегмент начинается с IDR кадра."


SYS (Настройки проекта > Профили зондов > SYSTEM)
+++++++++++++++++++++++++++++++++++++++++++++++++

.. csv-table:: 
   :header: "Имя триггера", "Тип", "Уровень", "Описание"  
   
   "Out of memory warning", "state", "Warning", "Предупреждение о превышении warning порога использования RAM."
   "Out of memory error", "state", "Error", "Ошибка, превышение error порога использования RAM."
   "High CPU usage warning", "state", "Warning", "Предупреждение о превышении warning порога использования CPU."
   "High CPU usage error", "state", "Error", "Ошибка, превышение error порога использования CPU."
   "Потеря связи с зондом", "event", "Major", "Потеря связи с зондом."
   "Потеря связи зонда с сервером", "event", "Major", "Потеря связи с сервером."
   "Переполнение видео буфера", "event", "Major", "Данные сбрасываются перед декодером. Недостаточная производительность зонда."
   "Ошибка загрузки библиотеки PCAP", "state", "Major", "Ошибка загрузки драйвера pcap/WinPcap. **Триггер срабатывает только в том случае, когда зонд имеет по крайней мере одну задачу с анализом Ethernet параметров.**"
   "Зафиксирована перезагрузка задачи", "event", "Major", "Дочерний процесс, анализирующий поток, был перезапущен родительским процессом, так как не отвечал в течение 10 сек."

Q: Как настроить профили порогов (thresholds)?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Перейдите в Настройки проекта > Профили задач > THRESHOLDS

.. figure:: _static/thresholds_tab_ru.png
       :scale: 100 %
       :align: center

Необходимо отредактировать профиль порогов. Для этого кликом выберите название профиля или скопируйте один из существующих профилей и отредактируйте его. Обратите внимание, что у каждого профиля есть счетчик, который указывает, сколько анализируемых задач имеет такой профиль. По умолчанию в созданном проекте доступны три профиля (их можно редактировать, удалять или создавать новые по их образу):

.. csv-table:: 
   :header: "**Профиль**", "**Мультикаст**", "**OTT**", "**Особенность**"
   :widths: 10, 10, 10, 50
   
   "TV", "Да", "Нет", "Для мониторинга SD IPTV. Включен анализ Ethernet параметров (базируется на драйвере pcap). Включена проверка TR 101 290."
   "HDTV", "Да", "Нет", "Для мониторинга HD IPTV. Включен анализ Ethernet параметров (базируется на драйвере pcap). Включена проверка TR 101 290. Имеет более узкие рамки по IAT и допускает больший битрейт чем профиль TV."
   "OTT", "Нет", "Да", "Для мониторинга SD/HD OTT. Включен анализ всех OTT событий. Отключена проверка TR 101 290 (при необходимости можно задействовать для незашифрованных сервисов или сервисов с AES-128). Отключено вычисление Ethernet параметров."
   
Ethernet parameters
+++++++++++++++++++

Данный чекбокс включает проверку `Ethernet параметров <probe.html#ethernet>`_ принимаемого потока. Т.е. при отключенном чекбоксе параметры IAT, DF и MLR вычисляться и отправляться на сервер не будут. Для профилей мониторинга OTT сервисов чекбокс должен быть отключен.


.. csv-table:: **Ethernet parameters**
   :header: "**Название порога**", "**Значение по умолчанию**", "**Описание**"
   :widths: 15, 15, 50
   
   "IAT Error, ms", "50 - TV, 30 - HDTV", "Время в миллисекундах, пороговое значение IAT, при котором зонд выставит значение Error."
   "IAT Warning, ms", "45 - TV, 20 - HDTV", "Время в миллисекундах, пороговое значение IAT, при котором зонд выставит значение Warning."
   "MLR Error", "8 - TV/HDTV", "Пороговое значение потерянных транспортных пакетов за секунду, при котором зонд выставит состояние Error."
   "MLR Warning", "1- TV/HDTV", "Пороговое значение потерянных транспортных пакетов за секунду, при котором зонд выставит состояние Warning."
   "Multicast Bitrate overflow, Kbps", "15000 - TV, 30000 - HDTV",  "Пороговое значение для мультикаст битрейта, при котором зонд выставит состояние превышение битрейта."
   "Multicast Bitrate underflow, Kbps", "100 - TV, 1000 - HDTV", "Пороговое значение для мультикаст битрейта, при котором зонд выставит состояние низкого битрейта."

TR 101 290
++++++++++

Данный чекбокс включает проверку соответствия потока стандарту TR 101 290. Стандарт регламентирует пороги, однако IPTV потоки не обязаны соответствовать строгим рамкам. В связи с этим, в системе введена возможность пользовательских настроек порогов, чтобы избежать нежелательных срабатываний триггеров. Проверку TR 101 290 можно использовать как для IPTV, так и для открытых OTT сервисов (либо сервисов, которые можно декриптовать).

.. csv-table:: **Проверять на соответствие TR 101 290**
   :header: "**Название порога**", "**Значение по умолчанию**", "**Описание**"
   :widths: 15, 15, 50
   
   "Интервал ошибок PAT, мс", "500", "PID 0x0000 (PAT таблица) должен передаваться в потоке не реже, чем установленный интервал в миллисекундах."
   "Интервал ошибок PMT, мс", "500", "Cекция с table_id 0x02 (т.н. PMT таблица) должна передаваться в потоке не реже, чем установленный интервал в миллисекундах. PMT таблица имеет PID, назначенный в таблице PAT. **Установка нуля в настройке порогов отключает детекцию PMT Error.**"
   "Интервал ошибок Audio/Video PID, мс", "5000", "Данные для заявленных аудио и видео PID не появляются в течение времени, установленного пользователем. Означает частичную потерю сервиса или ошибки в PAT/PMT таблицах. **Установка нуля в настройке порогов отключает детекцию AV PID error.**"
   "Интервал ошибок остальных PID, мс", "5000", "Данные для заявленных PID не появляются в течение установленного пользователем времени. Означает частичную потерю сервиса или ошибки в PAT/PMT таблицах. **Установка нуля в настройке порогов отключает детекцию PID error.**"
   "Интервал ошибок ClockContinuity, мс", "1000", "Время в миллисекундах, задает максимально допустимую разницу значений времени меток синхронизации PTS. Отрицательный прирост генерирует ошибку вне зависимости от величины порога. 
   **Установка нуля в настройке порогов отключает детекцию ClockContinuity.**"
   "Интервал фиксации VideoFreeze, с", "5", "Задает порог времени в секундах, если в течение этого интервала сохраняется состояние замирания, регистрируется факт замирания. Настройка чувствительности детектора замирания."

   
OTT control
+++++++++++

Данный чекбокс включает проверку OTT параметров и настройку Query String параметров. Должен быть включен для мониторинга OTT сервисов.

.. csv-table:: **OTT control**
   :header: "**Название порога**", "**Значение по умолчанию**", "**Описание**"
   :widths: 15, 15, 50
   
   "Download speed error, %", "100", "Когда скорость скачивания ниже, чем установленный порог **Download speed error**, выраженный в процентном соотношении, генерируется ошибка Download bitrate too low. Время загрузки / длительность чанка >= порог ошибки (%)."
   "Download speed warning, %", "80", "Когда скорость скачивания ниже, чем установленный порог Download speed warning, выраженный в процентном соотношении, генерируется предупреждение **Download bitrate low**. Время загрузки / длительность чанка >= порог предупреждения (%). Порог предупреждения не может быть выше порога ошибки."
   "Actual bitrate min, %", "50", "Средний битрейт скачанного сегмента меньше порога, установленного пользователем. Actual bitrate min задает нижнюю границу относительно битрейта, заявленного в плейлисте верхнего уровня, в процентах. Условие генерации ошибки **Actual bitrate**: Размер скачанного чанка / заявленная длительность <= заявленного битрейта профайла (%)."
   "Actual bitrate max, %", "200", "Средний битрейт скачанного сегмента больше порога, установленного пользователем. Actual bitrate max задает верхнюю границу относительно битрейта, заявленного в плейлисте верхнего уровня, в процентах. Условие генерации ошибки **Actual bitrate**: Размер скачанного чанка / заявленная длительность >= заявленного битрейта профайла (%)."
   "Number of identical playlist downloads", "3", "Задается число попыток скачивания плейлиста второго уровня. Между попытками выдерживается пауза, равная длительности последнего скачанного сегмента. Если плейлист второго уровня не обновился в течение нескольких скачиваний подряд, генерируется ошибка **Static manifest**."
   "Manifest size, bytes", "500000", "Если размер плейлиста превышает установленное пользователем пороговое значение, генерируется ошибка **Manifest size**."
   "Min. profiles", "1", "Если количество профилей, заявленных в главном плейлисте меньше, чем минимальное значение, заданное в настройках порогов, генерируется ошибка **Minimum profiles**"
   

HTTP query string parameters
++++++++++++++++++++++++++++

Секция предназначена для настройки дополнительных параметров в http запросе от зонда. Более подробная информация в разделе: «`Q: Как передать дополнительные параметры в http запросах от зонда?`_».

Настройка анализируемых задач
+++++++++++++++++++++++++++++

Перейдите на страницу зонда (например, кликнув на его имени в левой выпадающей панели).

.. important:: Зонд должен быть активным, и все необходимые анализируемые задачи должны быть запущены. 

Отметьте все задачи, для которых необходимо применить профиль порогов, и нажмите кнопку Конфигурировать. 

.. figure:: _static/Task_config_menu_threshold_ru.png
       :scale: 90 %
       :align: center

В раскрывшемся модальном окне выберите необходимый профиль для пункта Profile Threshold и нажмите кнопку Применить. Система настройки достаточно гибкая, например можно применять различные профили порогов к разным задачам одного зонда. 

.. note:: Задача не может не иметь профиля порогов. По умолчанию, задаче применяется профиль “TV”. 

Профили System
++++++++++++++

Часть настраиваемых порогов находится в системных профилях, относящихся к зонду. Перейдите Настройки проекта > Профили зондов > SYSTEM

.. figure:: _static/System_tab_ru.png
       :scale: 100 %
       :align: center

Необходимо отредактировать системный профиль. Для этого кликом выберите название профиля или скопируйте один из существующих профилей и отредактируйте его. Обратите внимание, что у каждого профиля есть счетчик, который указывает, сколько зондов имеет такой профиль.

Настройте пороги производительности системы.

.. csv-table:: **System**
   :header: "**Название порога**", "**Значение по умолчанию**", "**Описание**"
   :widths: 15, 15, 50
   
   "CPU warning, %", "70", "Процент загрузки CPU, при котором зонд выставит состояние CPU warning."
   "CPU error, %", "90", "Процент загрузки CPU, при котором зонд выставит состояние CPU error."
   "RAM warning, %", "70", "Процент утилизации RAM, при котором зонд выставит состояние RAM warning." 
   "RAM error, %", "90", "Процент утилизации RAM, при котором зонд выставит состояние RAM error."

Перейдите на страницу зонда (например, кликнув на его имени в левой выпадающей панели).

.. note:: Зонд должен быть активным.

Задайте из выпадающего списка (нажав надпись Изменить) необходимый профиль зонда.

.. figure:: _static/Probe_sys_profile_ru.png
       :scale: 100 %
       :align: center

Как настроить и использовать SNMP оповещение?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Общая информация
++++++++++++++++

Необходимо понимать, что система SNMP trap оповещения устроена так, что зонд в ней является шлюзом. Т.е. решение об отправке оповещения и само тело сообщения формируются на сервере и передаются зонду по протоколу https. Решение об оповещении принимается на сервере на основании преднастроенных триггеров. Зонд выполняет функцию шлюза, полученное от сервера сообщение пересылается по протоколу SNMP на указанный в настройках IP-адрес[:Порт] назначения ловушки.

MIB файлы
+++++++++

В пакет зонда, скачиваемого в личном кабинете, входят два MIB файла:

- `ELECARD-MIB.txt <https://boro.elecard.com/ELECARD-MIB.txt>`_
- `ELECARD-BORO-TRAP-MIB.txt <https://boro.elecard.com/ELECARD-BORO-TRAP-MIB.txt>`_

Данные файлы должны быть скопированы в необходимое место и добавлены в настройках вашей трап ловушки.

.. important:: Для передачи некоторых полей в MIB файле используется синтаксис “SnmpAdminString”, который поддерживает UTF-8 кодирование. UTF-8 имеет полную обратную совместимость с ASCII кодировкой. Поэтому при использовании только ASCII-символов в названиях зонда и анализируемых каналов, "SnmpAdminString" - поля будут выглядеть как ASCII строки.

Настройка порогов оповещений
++++++++++++++++++++++++++++

Настройте и примените профили задачам согласно разделу «`Q: Как настроить профили порогов (thresholds)?`_». Убедитесь, что для задач OTT мониторинга выбран профиль, в котором разрешен OTT контроль.

Настройка профиля SNMP оповещений
+++++++++++++++++++++++++++++++++

Перейдите Настройки проекта > Профили задач > SNMP

.. figure:: _static/SNMP_tab_ru.png
       :scale: 100 %
       :align: center

Необходимо отредактировать профиль SNMP оповещений. Для этого кликом выберите  название профиля или скопируйте один из существующих профилей и отредактируйте его. Обратите внимание, что у каждого профиля есть счетчик, который указывает, сколько анализируемых задач имеют такой профиль. Подробнее о том, как добавить задаче профиль, описано ниже (`Настройка анализируемых задач <web-server.html#id9>`_).

Установите часовой пояс и отметьте чекбокс “Отправлять оповещения об ошибках по протоколу SNMP”.  

Укажите Community string и установите до трех адресов назначений trap ловушек. Адрес вводится в формате IP:[PORT], например, 10.10.30.235:1234.
Если порт не указан, по умолчанию будет использоваться порт 162. 

Для рассылки SNMP trap сообщений реализован выбор шлюза (зонда). При выборе опции Triggered сообщения будут рассылаться через тот зонд, который анализирует поток (для которого сработал триггер). Опция Triggered необходима, если зонды находятся в разных сетях, и установлено несколько ловушек. Можно отправлять все SNMP trap сообщения через один зонд, для этого выберите его из выпадающего списка. 

.. note:: Чтобы имя зонда присутствовало в выпадающем списке, он должен быть успешно запущен, по крайней мере, один раз.

Далее включите и настройте необходимые триггеры. Триггеры разбиты по функциональным группам. Подробное описание параметров и событий можно найти в параграфе «`Регистрируемые параметры`_». Подробное описание триггеров представлено в разделе «`Триггеры событий`_».

После редактирования профиля нажмите кнопку Сохранить. 

.. note:: Для применения новых настроек может понадобиться до 1-2 мин., в зависимости от количества задач, использующих данный профиль.

.. note:: Чтобы запретить рассылку SNMP trap оповещений для всех задач, для которых в качестве профиля SNMP оповещений выбран, например, профиль default, снимите в настройках этого профиля чекбокс “Отправлять оповещения об ошибках по протоколу SNMP”.

Настройка анализируемых задач
+++++++++++++++++++++++++++++

Перейдите на страницу зонда (например, кликнув на его имени в левой выпадающей панели).

.. important:: Зонд должен быть активным, и все необходимые анализируемые задачи должны быть запущены.

Отметьте все задачи, для которых необходимо применить профиль SNMP оповещения, и нажмите кнопку Конфигурировать. 

В раскрывшемся модальном окне для пункта Profile SNMP выберите необходимый профиль и нажмите кнопку Применить. Таким образом, отправка SNMP trap сообщений будет разрешена для каждой выбранной задачи по настроенным в профиле триггерам. 

Система настройки достаточно гибкая, например, можно применять различные профили настроек к разным задачам одного зонда. 

.. figure:: _static/Task_config_menu_SNMP_ru.png
       :scale: 90 %
       :align: center

.. note:: Чтобы запретить какой-либо задаче отправлять SNMP trap оповещения, выберите “none” для пункта Profile SNMP.

После применения настроек задачам, должны начать отправляться trap оповещения (при условии срабатывания триггеров). Если параметры ловушки настроены корректно, она должна принимать сообщения.

Настройка и применение системного профиля
+++++++++++++++++++++++++++++++++++++++++

Настройка данного профиля опциональна. Данные настройки относятся к настройкам зонда.

Перейдите Настройки проекта > Профили зондов > SYSTEM

.. figure:: _static/System_tab_ru.png
       :scale: 100 %
       :align: center

Необходимо отредактировать системный профиль. Для этого кликом выберите название профиля или скопируйте один из существующих профилей и отредактируйте его. Обратите внимание, что у каждого профиля есть счетчик, который указывает, сколько зондов имеют такой профиль.

В правой нижней части страницы есть область, где сгруппированы настройки системных оповещений по протоколу SNMP. Как указано в предыдущем разделе, необходимо:

- указать Community string,
- задать адрес ловушки IP:[PORT],
- выбрать зонд через который будет вестись оповещение или оставить настройку Triggered,
- выбрать и настроить необходимые триггеры, 
- сохраните изменения.

Перейдите на страницу зонда (например, кликнув на его имени в левой выпадающей панели).

.. important:: Зонд должен быть активным.

Задайте из выпадающего списка (нажав надпись Изменить) необходимый профиль зонда.

.. figure:: _static/Probe_sys_profile_ru.png
       :scale: 100 %
       :align: center

Структура SNMP trap сообщения
+++++++++++++++++++++++++++++

Для работы необходимо иметь два MIB файла, входящие в пакет анализаторов:

- `ELECARD-MIB.txt <https://boro.elecard.com/ELECARD-MIB.txt>`_
- `ELECARD-BORO-TRAP-MIB.txt <https://boro.elecard.com/ELECARD-BORO-TRAP-MIB.txt>`_

Решение об отправке сообщений основывается на анализе предустановленных триггеров (см. раздел «`Триггеры событий`_»). 

Существует три разновидности SNMP trap сообщений, описанных в ELECARD-BORO-TRAP-MIB файле:

**1. Сообщение о смене состояния (state в** «`Триггеры событий`_»)
		Такие сообщения отправляются дважды, при появлении события и при его окончании.
		
		``{ status, probeName, taskName, errorName, level, beginTime, endTime, trapTime }``
			
			**status** - active|cleared состояние активно или снято
			
			**probeName** - имя зонда, анализирующего поток, для которого сработал триггер
			
			**taskName** - название и URI потока, для которого сработал триггер
			
			**errorName** - название ошибки (триггера)
			
			**level** - уровень критичности ошибки, заданный в настройках триггера
			
			**beginTime** - время начала состояния
			
			**endTime** - если status = active передается ноль, если status = cleared время выхода из состояния
			
			**trapTime**  - время генерации SNMP trap сообщения

**2. Сообщение о событии (event в** «`Триггеры событий`_»)
		Сообщение отправляется единожды, когда срабатывает триггер с типом event.
		
		``{ probeName, taskName, errorName, level, beginTime, endTime, errorsCount, trapTime }``
			
			**probeName** - имя зонда, анализирующего поток, для которого сработал триггер
			
			**taskName** - название и URI потока, для которого сработал триггер
			
			**errorName** - название ошибки (триггера)
			
			**level** - уровень критичности ошибки, заданный в настройках триггера
			
			**beginTime** - время начала события (для Continuity Counter и Clock Continuity время регистрации первой ошибки)
			
			**endTime** - для Continuity Counter и Clock Continuity время регистрации последней ошибки, для остальных событий передаются нули.
			
			**errorsCount** - число ошибок для событий Continuity Counter и Clock Continuity за период, для остальных событий передается единица.
			
			**trapTime**  - время генерации SNMP trap сообщения

**3. Сообщение о потере пробой сервера**
		Сообщение отправляется зондом, который утратил соединение с сервером. На сообщения такого типа не действует выбор шлюза (пробы), т.е. сообщение будет отправлено именно тем зондом, который утратил соединение.
		
		``{ probeName, messageError, beginTime }``
			
			**probeName** - имя зонда, утратившего соединение
			
			**messageError** - сообщение о потере связи с сервером
			
			**beginTime** - время начала состояния

Мониторинг OTT сервисов
-----------------------

Q: Как изменить User-agent в http запросах от зонда?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

User-Agent - это текстовая строка, являющаяся частью заголовка HTTP запроса, начинающаяся с User-agent: или User-Agent:, и обычно включающая такую информацию, как название и версия приложения, операционная система компьютера и язык. 

Если данное поле не заполнено, в качестве User-agent используется "Boro client (<PLATFORM>) <VERSION>" по умолчанию.

Если необходимо задать собственный User-agent, перейдите Настройки проекта > Профили зондов > SYSTEM

.. figure:: _static/System_tab_ru.png
       :scale: 100 %
       :align: center

Необходимо отредактировать системный профиль. Для этого кликом выберите название профиля или скопируйте один из существующих профилей и отредактируйте его. Обратите внимание, что у каждого профиля есть счетчик, который указывает, сколько зондов имеют такой профиль.

Введите в поле UserAgent пользовательское значение (строка длиной до 4kB) и нажмите кнопку Сохранить внизу страницы.

Перейдите на страницу зонда (например, кликнув на его имени в левой выпадающей панели).

.. important:: Зонд должен быть активным.

Задайте из выпадающего списка (нажав надпись **Изменить**) необходимый профиль зонда.

.. figure:: _static/Probe_sys_profile_ru.png
       :scale: 100 %
       :align: center

После применения настроенного профиля зонд будет отправлять запросы с указанным User-Agent.

Как передать дополнительные параметры в http запросах от зонда?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

**Query string parameters** - строка, является частью URL и содержит данные, которые необходимо передать на сервер, и которые не могут быть включены в структуру пути.

Параметры задаются в профилях порогов. Как настроить и применить профили порогов описано в разделе «`Q: Как настроить профили порогов (thresholds)?`_».

.. important:: Чекбокс “OTT control” должен быть включен.

В разделе HTTP query string parameters задайте необходимые параметры. Используйте кнопку “+”, чтобы добавить больше параметров. После завершения редактирования сохраните профиль, нажав зеленую кнопку Сохранить. 

Например, строка запроса без применения параметров выглядела так:
``http://MyOTTservice.com/service1.m3u8``

Если в настройках порогов задать следующие параметры,

.. figure:: _static/Query_String_parameters_ru_en.png
       :scale: 100 %
       :align: center

строка запроса будет передана так:

``http://MyOTTservice.com/service1.m3u8?param1=val1&param2=val2``

Примените настроенный профиль порогов в настройках задач. 

**Force** - принудительное переназначение указанных параметров, если они присутствуют в строке запроса. Если настройка force отключена, то переназначение применяться не будет для параметров с совпадающим названием. Если указанные параметры отсутствуют в строке запроса, они будут добавлены вне зависимости от состояния force.